name: Release to Launchpad PPA

on:
  push:
    tags:
      - "v*"
    paths:
      - "src/linux/**"
  workflow_dispatch:

jobs:
  publish-to-ppa:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        distro:
          - focal
          - jammy
          - noble

    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            devscripts \
            debhelper \
            gnupg \
            dput \
            build-essential

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import

          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG \
            | awk '/^sec/ {print $2}' \
            | cut -d'/' -f2 \
            | head -n1)

          echo "KEY_ID=$KEY_ID" >> "$GITHUB_ENV"

          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg

          cat > ~/.gnupg/gpg.conf << EOF
          use-agent
          pinentry-mode loopback
          EOF

          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye

          echo "test" | gpg --batch --yes \
            --passphrase "$GPG_PASSPHRASE" \
            --pinentry-mode loopback \
            -s -u "$KEY_ID" > /dev/null

      - name: Create Debian source package
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          DISTRO=${{ matrix.distro }}
          PPA_VERSION="${VERSION}-1~${DISTRO}1"

          PKGDIR="gitcommit-${VERSION}"
          mkdir "$PKGDIR"
          cd "$PKGDIR"

          install -m 0755 ../src/linux/gitcommit.sh gitcommit

          cd ..
          tar czf gitcommit_${VERSION}.orig.tar.gz "$PKGDIR"
          cd "$PKGDIR"

          mkdir -p debian/source

          cat > debian/control << EOF
          Source: gitcommit
          Section: utils
          Priority: optional
          Maintainer: Clove Twilight <clovetwilight3@outlook.com>
          Build-Depends: debhelper-compat (= 13)
          Standards-Version: 4.6.2

          Package: gitcommit
          Architecture: all
          Depends: git (>= 2.0), \${misc:Depends}
          Description: Automated Git workflow tool
           GitCommit automates common Git workflows such as
           staging, committing, pulling, pushing, and branch switching.
          EOF

          cat > debian/changelog << EOF
          gitcommit (${PPA_VERSION}) ${DISTRO}; urgency=medium

            * New upstream release

           -- Clove Twilight <clovetwilight3@outlook.com>  $(date -R)
          EOF

          cat > debian/rules << 'EOF'
          #!/usr/bin/make -f
          %:
          	dh $@

          override_dh_auto_install:
          	install -D -m 0755 gitcommit debian/gitcommit/usr/bin/gitcommit
          EOF
          chmod +x debian/rules

          echo "3.0 (quilt)" > debian/source/format

          cat > debian/copyright << EOF
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: gitcommit
          Source: https://github.com/CloveTwilight3/GitCommit

          Files: *
          Copyright: 2025 Clove Twilight
          License: MIT
          EOF

      - name: Build source package
        env:
          DEBFULLNAME: "Clove Twilight"
          DEBEMAIL: "clovetwilight3@outlook.com"
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          cd "gitcommit-${VERSION}"

          debuild -S -sa -k"$KEY_ID" --no-tgz-check

      - name: Upload to Launchpad PPA
        run: |
          dput ppa:clovetwilight3/gitcommit *_source.changes

      - name: Success message
        run: |
          echo "Uploaded gitcommit ${{ steps.get_version.outputs.VERSION }} for Ubuntu ${{ matrix.distro }}"
