name: Release to Launchpad PPA

on:
  push:
    tags:
      - "v*"
    paths:
      - "src/linux/**"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.1.2)'
        required: true
        type: string

jobs:
  # First job: Create the orig.tar.gz once
  create-source-tarball:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    
    steps:
      - uses: actions/checkout@v6

      - name: Get version from tag
        id: get_version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="dev"
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION"

      - name: Create orig.tar.gz
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          PKGDIR="gitcommit-${VERSION}"
          
          mkdir "$PKGDIR"
          install -m 0755 src/linux/gitcommit.sh "$PKGDIR/gitcommit"
          
          tar czf "gitcommit_${VERSION}.orig.tar.gz" "$PKGDIR"

      - name: Upload orig.tar.gz artifact
        uses: actions/upload-artifact@v6
        with:
          name: source-tarball
          path: gitcommit_*.orig.tar.gz
          retention-days: 1

  # Second job: Build packages for each distro
  build-packages:
    needs: create-source-tarball
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        distro:
          - focal
          - jammy
          - noble

    steps:
      - uses: actions/checkout@v6

      - name: Download orig.tar.gz artifact
        uses: actions/download-artifact@v4
        with:
          name: source-tarball

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            devscripts \
            debhelper \
            gnupg \
            build-essential

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import

          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG \
            | awk '/^sec/ {print $2}' \
            | cut -d'/' -f2 \
            | head -n1)

          echo "KEY_ID=$KEY_ID" >> "$GITHUB_ENV"

          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg

          cat > ~/.gnupg/gpg.conf << EOF
          use-agent
          pinentry-mode loopback
          EOF

          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye

          echo "test" | gpg --batch --yes \
            --passphrase "$GPG_PASSPHRASE" \
            --pinentry-mode loopback \
            -s -u "$KEY_ID" > /dev/null

      - name: Create Debian source package
        run: |
          VERSION=${{ needs.create-source-tarball.outputs.version }}
          DISTRO=${{ matrix.distro }}
          RUN_NUMBER=${{ github.run_number }}
          PPA_VERSION="${VERSION}-${RUN_NUMBER}~${DISTRO}1"

          PKGDIR="gitcommit-${VERSION}"
          
          # Extract the orig.tar.gz we downloaded
          tar xzf "gitcommit_${VERSION}.orig.tar.gz"
          cd "$PKGDIR"

          mkdir -p debian/source

          # Use debhelper-compat 12 for focal, 13 for newer
          if [ "$DISTRO" = "focal" ]; then
            DEBHELPER_COMPAT="12"
          else
            DEBHELPER_COMPAT="13"
          fi

          cat > debian/control << EOF
          Source: gitcommit
          Section: utils
          Priority: optional
          Maintainer: Clove Twilight <clovetwilight3@outlook.com>
          Build-Depends: debhelper-compat (= ${DEBHELPER_COMPAT})
          Standards-Version: 4.6.2

          Package: gitcommit
          Architecture: all
          Depends: git (>= 2.0), \${misc:Depends}
          Description: Automated Git workflow tool
           GitCommit automates common Git workflows such as
           staging, committing, pulling, pushing, and branch switching.
          EOF

          cat > debian/changelog << EOF
          gitcommit (${PPA_VERSION}) ${DISTRO}; urgency=medium

            * New upstream release

           -- Clove Twilight <clovetwilight3@outlook.com>  $(date -R)
          EOF

          cat > debian/rules << 'EOF'
          #!/usr/bin/make -f
          %:
          	dh $@

          override_dh_auto_install:
          	install -D -m 0755 gitcommit debian/gitcommit/usr/bin/gitcommit
          EOF
          chmod +x debian/rules

          echo "3.0 (quilt)" > debian/source/format

          cat > debian/copyright << EOF
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: gitcommit
          Source: https://github.com/CloveTwilight3/GitCommit

          Files: *
          Copyright: 2025 Clove Twilight
          License: MIT
          EOF

      - name: Build source package
        env:
          DEBFULLNAME: "Clove Twilight"
          DEBEMAIL: "clovetwilight3@outlook.com"
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          VERSION=${{ needs.create-source-tarball.outputs.version }}
          cd "gitcommit-${VERSION}"

          debuild -S -sa -k"$KEY_ID"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: deb-packages-${{ matrix.distro }}
          path: |
            *.changes
            *.dsc
            *.tar.xz
            *.buildinfo
          retention-days: 1

  # Third job: Upload all packages to PPA
  upload-to-ppa:
    needs: [create-source-tarball, build-packages]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages

      - name: Install dput and GPG
        run: |
          sudo apt-get update
          sudo apt-get install -y dput gnupg

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import

          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG \
            | awk '/^sec/ {print $2}' \
            | cut -d'/' -f2 \
            | head -n1)

          echo "KEY_ID=$KEY_ID" >> "$GITHUB_ENV"

          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg

          cat > ~/.gnupg/gpg.conf << EOF
          use-agent
          pinentry-mode loopback
          EOF

          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye

      - name: Organize packages
        run: |
          # Create upload directory
          mkdir -p upload
          
          # Move all package files to upload directory
          find packages -name "*.changes" -exec mv {} upload/ \;
          find packages -name "*.dsc" -exec mv {} upload/ \;
          find packages -name "*.tar.xz" -exec mv {} upload/ \;
          find packages -name "*.tar.gz" -exec mv {} upload/ \;
          find packages -name "*.buildinfo" -exec mv {} upload/ \;
          
          # List what we're uploading
          echo "Files to upload:"
          ls -lah upload/

      - name: Upload all packages to Launchpad PPA
        run: |
          cd upload
          for changes_file in *.changes; do
            echo "Uploading $changes_file..."
            dput ppa:clovetwilight3/gitcommit "$changes_file"
          done

      - name: Success message
        run: |
          echo "Successfully uploaded all packages for gitcommit ${{ needs.create-source-tarball.outputs.version }}"
          echo "Uploaded for: focal, jammy, noble"