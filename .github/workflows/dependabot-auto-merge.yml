name: Dependabot auto-merge
on: 
  pull_request:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to merge'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: ${{ github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Configure Git
        run: |
          git config --global user.name 'CloveTwilight3 [BOT]'
          git config --global user.email '193822784+CloveTwilightBOT@users.noreply.github.com'
        
      - name: Get PR info (for manual trigger)
        if: github.event_name == 'workflow_dispatch'
        id: pr_info
        run: |
          echo "Checking PR #${{ github.event.inputs.pr_number }}"
          PR_DATA=$(gh pr view ${{ github.event.inputs.pr_number }} --json author,headRefName,state)
          echo "PR Data: $PR_DATA"
          AUTHOR=$(echo $PR_DATA | jq -r '.author.login')
          echo "Author: $AUTHOR"
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Dependabot metadata (for automatic trigger)
        if: github.event_name == 'pull_request'
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      
      - name: Auto-merge Dependabot PRs
        if: |
          (github.event_name == 'pull_request' && 
           (steps.metadata.outputs.update-type == 'version-update:semver-patch' || 
            steps.metadata.outputs.update-type == 'version-update:semver-minor')) ||
          (github.event_name == 'workflow_dispatch' && 
           steps.pr_info.outputs.author == 'app/dependabot')
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          echo "Attempting to merge PR #$PR_NUMBER"
          
          # Try merge commit first
          if gh pr merge --merge "$PR_NUMBER" --body "Auto-merged by Dependabot workflow"; then
            echo "✅ PR #$PR_NUMBER merged successfully with merge commit"
          # If that fails, try squash merge
          elif gh pr merge --squash "$PR_NUMBER" --body "Auto-merged by Dependabot workflow"; then
            echo "✅ PR #$PR_NUMBER merged successfully with squash"
          # If that fails, try rebase merge
          elif gh pr merge --rebase "$PR_NUMBER" --body "Auto-merged by Dependabot workflow"; then
            echo "✅ PR #$PR_NUMBER merged successfully with rebase"
          else
            echo "❌ Failed to merge PR #$PR_NUMBER with all merge methods (merge, squash, rebase)"
            echo "This could be due to:"
            echo "  - Merge conflicts"
            echo "  - Branch protection rules"
            echo "  - Required status checks not passing"
            echo "  - Insufficient permissions"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
