name: Release to AUR

on:
  push:
    tags:
      - 'v*'
    paths:
      - 'src/linux/**'
  workflow_dispatch:

jobs:
  publish-to-aur:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Generate SHA256 checksums
        id: checksums
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          
          # Download files from the repository
          wget -O gitcommit.sh "https://raw.githubusercontent.com/CloveTwilight3/GitCommit/v${VERSION}/src/linux/gitcommit.sh"
          wget -O LICENSE "https://raw.githubusercontent.com/CloveTwilight3/GitCommit/v${VERSION}/LICENSE"
          
          # Generate checksums
          SCRIPT_SHA=$(sha256sum gitcommit.sh | awk '{print $1}')
          LICENSE_SHA=$(sha256sum LICENSE | awk '{print $1}')
          
          echo "SCRIPT_SHA=$SCRIPT_SHA" >> $GITHUB_OUTPUT
          echo "LICENSE_SHA=$LICENSE_SHA" >> $GITHUB_OUTPUT
          
          echo "Script SHA256: $SCRIPT_SHA"
          echo "License SHA256: $LICENSE_SHA"
      
      - name: Update PKGBUILD
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          SCRIPT_SHA=${{ steps.checksums.outputs.SCRIPT_SHA }}
          LICENSE_SHA=${{ steps.checksums.outputs.LICENSE_SHA }}
          
          # Create updated PKGBUILD
          cat > PKGBUILD << EOF
          # Maintainer: Clove Twilight <clovetwilight3@outlook.com>
          pkgname=gitcommit
          pkgver=${VERSION}
          pkgrel=1
          pkgdesc="Automated Git workflow tool"
          arch=('any')
          url="https://github.com/CloveTwilight3/GitCommit"
          license=('MIT')
          depends=('git' 'bash')
          source=("gitcommit.sh::https://raw.githubusercontent.com/CloveTwilight3/GitCommit/v\${pkgver}/src/linux/gitcommit.sh"
                  "LICENSE::https://raw.githubusercontent.com/CloveTwilight3/GitCommit/v\${pkgver}/LICENSE")
          sha256sums=('${SCRIPT_SHA}'
                      '${LICENSE_SHA}')
          
          package() {
              # Install the main script
              install -Dm755 "\$srcdir/gitcommit.sh" "\$pkgdir/usr/bin/gitcommit"
              
              # Install license
              install -Dm644 "\$srcdir/LICENSE" "\$pkgdir/usr/share/licenses/\$pkgname/LICENSE"
          }
          EOF
          
          cat PKGBUILD
      
      - name: Generate .SRCINFO manually
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          SCRIPT_SHA=${{ steps.checksums.outputs.SCRIPT_SHA }}
          LICENSE_SHA=${{ steps.checksums.outputs.LICENSE_SHA }}
          
          # Create .SRCINFO manually
          cat > .SRCINFO << EOF
          pkgbase = gitcommit
          	pkgdesc = Automated Git workflow tool
          	pkgver = ${VERSION}
          	pkgrel = 1
          	url = https://github.com/CloveTwilight3/GitCommit
          	arch = any
          	license = MIT
          	depends = git
          	depends = bash
          	source = gitcommit.sh::https://raw.githubusercontent.com/CloveTwilight3/GitCommit/v${VERSION}/src/linux/gitcommit.sh
          	source = LICENSE::https://raw.githubusercontent.com/CloveTwilight3/GitCommit/v${VERSION}/LICENSE
          	sha256sums = ${SCRIPT_SHA}
          	sha256sums = ${LICENSE_SHA}
          
          pkgname = gitcommit
          EOF
          
          cat .SRCINFO
      
      - name: Set up SSH for AUR
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          
          # Add AUR to known hosts
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts
          
          # Configure SSH to use the key for AUR
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
          EOF
      
      - name: Configure Git
        run: |
          git config --global user.name "Clove Twilight"
          git config --global user.email "clovetwilight3@outlook.com"
      
      - name: Clone AUR repository
        run: |
          git clone ssh://aur@aur.archlinux.org/gitcommit.git aur-repo
      
      - name: Update AUR repository
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          
          # Copy updated files
          cp PKGBUILD aur-repo/
          cp .SRCINFO aur-repo/
          
          cd aur-repo
          
          # Check if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            git add PKGBUILD .SRCINFO
            git commit -m "Update to version ${VERSION}"
            git push
            echo "Successfully pushed to AUR!"
          else
            echo "No changes to commit"
          fi
      
      - name: Notify success
        if: success()
        run: |
          echo "Successfully updated GitCommit v${{ steps.get_version.outputs.VERSION }} on AUR!"
          echo "AUR Package: https://aur.archlinux.org/packages/gitcommit"
