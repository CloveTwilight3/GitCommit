name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-powershell:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install PowerShell
      uses: actions/setup-powershell@v1
      
    - name: Run PowerShell Script Analyzer
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        $results = Invoke-ScriptAnalyzer -Path "src/" -Recurse -Severity Warning
        if ($results) {
          $results | Format-Table
          exit 1
        }
        Write-Host "✅ PowerShell Script Analyzer passed"
        
    - name: Test Git Commands (Dry Run)
      run: |
        # Test that the script can parse without syntax errors
        $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content "src/GitCommit.ps1" -Raw), [ref]$null)
        Write-Host "✅ PowerShell script syntax is valid"
        
    - name: Test Installer Script
      run: |
        # Test installer script syntax
        $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content "installers/powershell/Install-GitCommit.ps1" -Raw), [ref]$null)
        Write-Host "✅ Installer script syntax is valid"

  test-cross-platform:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install PowerShell
      run: |
        # Install PowerShell on Linux
        wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
        sudo dpkg -i packages-microsoft-prod.deb
        sudo apt-get update
        sudo apt-get install -y powershell
        
    - name: Test PowerShell Script on Linux
      run: |
        # Test basic script parsing
        pwsh -Command "
        try {
          \$null = [System.Management.Automation.PSParser]::Tokenize((Get-Content 'src/GitCommit.ps1' -Raw), [ref]\$null)
          Write-Host '✅ PowerShell script works on Linux'
        } catch {
          Write-Host '❌ PowerShell script failed on Linux'
          exit 1
        }
        "