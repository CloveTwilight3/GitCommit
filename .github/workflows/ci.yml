name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-powershell:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run PowerShell Script Analyzer
      shell: pwsh
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        $results = Invoke-ScriptAnalyzer -Path "src/win/" -Recurse -Severity Warning
        if ($results) {
          $results | Format-Table
          exit 1
        }
        Write-Host "✅ PowerShell Script Analyzer passed"
        
    - name: Test Git Commands (Dry Run)
      shell: pwsh
      run: |
        # Test that the script can parse without syntax errors
        $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content "src/win/GitCommit.ps1" -Raw), [ref]$null)
        Write-Host "✅ PowerShell script syntax is valid"

  test-bash:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install ShellCheck
      run: sudo apt-get update && sudo apt-get install -y shellcheck
      
    - name: Test Bash Script Syntax
      run: |
        bash -n src/linux/gitcommit.sh
        echo "✅ Bash script syntax is valid"
        
    - name: Run ShellCheck
      run: |
        shellcheck src/linux/gitcommit.sh || true
        echo "✅ ShellCheck completed"

  test-cross-platform:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test PowerShell Script on Linux
      shell: pwsh
      run: |
        # Test basic script parsing
        try {
          $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content 'src/win/GitCommit.ps1' -Raw), [ref]$null)
          Write-Host '✅ PowerShell script works on Linux'
        } catch {
          Write-Host '❌ PowerShell script failed on Linux'
          exit 1
        }

  validate-chocolatey:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Chocolatey Package
      shell: pwsh
      run: |
        # Validate nuspec file exists
        if (-not (Test-Path "src/win/gitcommit.nuspec")) {
          Write-Host "❌ gitcommit.nuspec not found"
          exit 1
        }
        
        # Create tools directory
        New-Item -ItemType Directory -Path "src/win/tools" -Force | Out-Null
        
        # Copy files to tools for packaging
        Copy-Item "src/win/GitCommit.ps1" -Destination "src/win/tools/" -Force
        Copy-Item "src/win/GitCommit.bat" -Destination "src/win/tools/" -Force
        
        # Test pack
        cd src/win
        choco pack gitcommit.nuspec
        
        Write-Host "✅ Chocolatey package validation passed"
        
  validate-pkgbuild:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate PKGBUILD Syntax
      run: |
        # Check PKGBUILD exists
        if [ ! -f "src/linux/PKGBUILD" ]; then
          echo "❌ PKGBUILD not found"
          exit 1
        fi
        
        # Basic syntax validation
        bash -n src/linux/PKGBUILD || {
          echo "❌ PKGBUILD has syntax errors"
          exit 1
        }
        
        # Check required fields
        grep -q "pkgname=" src/linux/PKGBUILD || { echo "❌ Missing pkgname"; exit 1; }
        grep -q "pkgver=" src/linux/PKGBUILD || { echo "❌ Missing pkgver"; exit 1; }
        grep -q "pkgrel=" src/linux/PKGBUILD || { echo "❌ Missing pkgrel"; exit 1; }
        grep -q "arch=" src/linux/PKGBUILD || { echo "❌ Missing arch"; exit 1; }
        
        echo "✅ PKGBUILD validation passed"
